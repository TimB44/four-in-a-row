<script>
  import Board from "./Board.svelte";
  import GameEndScreen from "./GameEndScreen.svelte";
  import { onMount } from "svelte";
  import { createEventDispatcher } from "svelte";

  export let botDiff = "easy";
  export let playerIsFirst = true;

  let dispatch = createEventDispatcher();
  let gameIsOver = false;
  let gameOverText = "";
  let board;

  onMount(() => {
    if (!playerIsFirst) {
      board.disableButtons();
    }
  });

  async function playAIMove() {
    let resp = await fetch("/ai", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        board: board.getBoard(),
        difficulty: botDiff,
      }),
    });
    if (!resp.ok) {
      console.log("Could not get AI move from server");
      errorEvent("Could not get AI move from server");
      return;
    }
    let json = await resp.json();

    let move = json["move"];
    board.playMove(move);
    board.enableButtons();
  }

  function errorEvent(msg = "") {
    dispatch("error", {
      message: msg,
    });
  }
</script>

{#if gameIsOver}
  <GameEndScreen
    on:replayClicked={() => {
      gameIsOver = false;
      board.clear();
    }}
    on:menuClicked
    gameText={gameOverText}
  />
{/if}
<Board
  bind:this={board}
  on:playerMove={playAIMove}
  on:error
  on:gameEnd={(e) => {
    gameOverText = e.detail.message;
    gameIsOver = true;
  }}
/>

<style>
</style>
